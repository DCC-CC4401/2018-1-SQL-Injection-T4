{% extends 'application_layout.html' %}

{% block title %}
Sistema de Reserva CEI - Ver Espacios
{% endblock %}

{% block body %}

<div class="container">
    <br>
    <div class="row">
        <div class="col-4"></div>
        <div class="col-4" style="text-align: center;">
            <div style="margin:0; padding:0; width: auto;" class="btn-group" role="group" aria-label="Basic example">
                <a href="{% url 'landing_articles' %}"  class="btn btn-light" role="button" aria-disabled="false">Artículos</a>
                <a href="" class="btn btn-success disabled" role="button" aria-disabled="true">Espacios</a>
            </div>
        </div>
        <div class="col-4"></div>
    </div>
    <div class="row" style="margin-top: 2em;">
        <div class="col-6 offset-3 schedule-current-week" style="text-align: center;">
          <div class="alert alert-info">
            <p>Estás viendo la semana del lunes <b>{{ actual_monday }}</b></p>
          </div>
        </div>
    </div>
    <div class="container">
            {% include '_schedule_landing_filtered.html' %}
        <div class="col-md-6 spaces-container">
        <h1>Filtrar por espacio</h1>
        <form action="{% url 'spaces_list' %}" method="post">
        {% csrf_token %}
        <table id="spaces-table" class="table table-striped">

          <thead>
          <tr>
            <th scope="col">Nombre del Espacio</th>
            <th scope="col"> Seleccionar</th>
          </tr>
          </thead>
          <tbody>

          {% for space in spaces %}
          <tr>
            <!-- <td>{{ space.name }}</td> -->
            <td><a href="{% url 'space_data' space.id%}">{{ space.name }}</a></td>
            <td><input type="checkbox" name="selected" value="{{ space.id }}"></td>
          </tr>
          {% endfor %}

          </tbody>
        </table>
        <div class="row">
            <button class="reserv_input" name="accept" value="1" type="submit">Filtrar</button>
        </div>
        </form>
      </div>

            <form method="post" id="reservation-form">
                {% csrf_token %}
                <div class="row">
                    <div class="form-group" style="padding: 5px">
                        <label for="picked-date">Fecha</label>
                        <input class="form-control" name="picked-date"
                               id="picked-date" type="text" value=""
                               data-pseudo-time="-1" readonly><br>
                    </div>
                    <div class="form-group" style="padding: 5px">
                        <label for="picked-start-time">Hora inicio</label>
                        <input class="form-control" name="picked-start-time"
                               id="picked-start-time" type="text" value=""
                               data-pseudo-time="-1" readonly><br>
                    </div>
                    <div class="form-group" style="padding: 5px">
                        <label for="picked-end-time">Hora final</label>
                        <input class="form-control" name="picked-end-time"
                               id="picked-end-time" type="text" value=""
                               data-pseudo-time="-1" readonly><br>
                    </div>
                </div>
                <button type="submit" class="btn" value="Hacer Reserva"
                        onclick="document.getElementById('reservation-form').submit()">
                    Hacer Reserva
                </button>
            </form>
    </div>

</div>


<script>
    $(document).ready(function(){
        // "Lunes","Martes","Miercoles","Jueves","Viernes"
        $('.week-day li').on('click', function(e){
            el = $(e.target)
            selectDate(el)
        })
    })
    function selectDate(el){
        date = $("#picked-date")
        weekday = el.closest('.week-day')
        // console.log(weekday.data("day-num"))

        if (date.val() == ""){
            selectStartTime(el)
        } else {
            if(date.val() == weekday.data('day')){
                selectEndTime(el)
            } else {
                selectStartTime(el)
            }
            // date.val(weekday.data('day'))
        }
        date.val(weekday.data('day'))
    }

    function selectStartTime(el){
        startTime = $("#picked-start-time")
        startTime.val(el.data("time"))

        startTime.data("pseudo-time", el.data("pseudo-time"))

        // unselect end time data
        endTime = $("#picked-end-time")
        endTime.val("")
        endTime.data("pseudo-time", -1)

        //paint cells
        startPseudoTime = parseInt(startTime.data("pseudo-time"))
        paintCells(el, startPseudoTime,  startPseudoTime)
    }

    function selectEndTime(el){
        startTime = $("#picked-start-time")
        endTime = $("#picked-end-time")
        endTime.data("pseudo-time", el.data("pseudo-time"))

        startPseudoTime = parseInt(startTime.data("pseudo-time"))
        endPseudoTime = parseInt(endTime.data("pseudo-time"))

        if (startPseudoTime < endPseudoTime){
            endTime.val(el.data("time"))
            paintCells(el, startPseudoTime, endPseudoTime)
        } else {
            selectStartTime(el)
        }

    }
    function paintCells(el, ini, end){
        clearPaintedCells()

        weekday = el.closest('.week-day')
        weekday.find("li").filter(function(ind){
            elTime = parseInt($(this).data("pseudo-time"))
            return elTime <= end && elTime >= ini
        }).addClass("bg-primary")
    }

    function clearPaintedCells(){
        $('li').removeClass("bg-primary")
    }
</script>

{% endblock %}


